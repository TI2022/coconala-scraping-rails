class AccountsController < ApplicationController
  require 'csv'

  before_action :set_account, only: [:transfer_slip_edit, :transfer_slip_update, :transfer_slip_destroy]
  
  before_action :set_accounts, only: [:journal_books, :balance_sheet, :profit_and_loss_statement]
  
  before_action :logged_in_user, only: [:all_general_ledger, :master_general_ledger, :sub_master_general_ledger,
                                        :journal_books, :balance_sheet, :profit_and_loss_statement,
                                        :ocr_new, :ocr_create, :ocr_upload,
                                        :transfer_slip_new, :transfer_slip_create, :transfer_slip_edit, :transfer_slip_update, :transfer_slip_destroy]

  before_action :admin_and_accounting_user, only: [:all_general_ledger, :master_general_ledger, :sub_master_general_ledger,
                                                  :journal_books, :balance_sheet, :profit_and_loss_statement,
                                                  :ocr_new, :ocr_create, :ocr_upload,
                                                  :transfer_slip_new, :transfer_slip_create, :transfer_slip_edit, :transfer_slip_update, :transfer_slip_destroy]

  before_action :set_one_month, only: [:all_general_ledger, :master_general_ledger, :sub_master_general_ledger,
                                      :journal_books, :balance_sheet, :profit_and_loss_statement,
                                      :ocr_new, :ocr_create, :ocr_upload,
                                      :transfer_slip_new, :transfer_slip_create, :transfer_slip_edit, :transfer_slip_update, :transfer_slip_destroy]

  before_action :ocr_right_account_titles, only: [:ocr_new, :ocr_create, :ocr_upload]
  before_action :ocr_account_titles, only: [:ocr_new, :ocr_create, :ocr_upload]
  before_action :transfer_slip_account_titles, only: [:ocr_new, :ocr_create, :ocr_upload, :transfer_slip_new, :transfer_slip_create, :transfer_slip_edit]
  before_action :tax_rate_arys, only: [:ocr_new, :ocr_create, :ocr_upload, :transfer_slip_new, :transfer_slip_create, :transfer_slip_edit, :transfer_slip_update, :transfer_slip_destroy]
  before_action :sub_account_titles, only: [:ocr_new, :ocr_create, :ocr_upload, :transfer_slip_new, :transfer_slip_create, :transfer_slip_edit, :transfer_slip_update, :transfer_slip_destroy]
  
  before_action :left_account_titles, only: :all_general_ledger
  before_action :right_account_titles, only: :all_general_ledger
  
  before_action :amount_of_sales, only: [:profit_and_loss_statement, :balance_sheet]
  before_action :cost_of_sales, only: [:profit_and_loss_statement, :balance_sheet]
  before_action :administrative_expenses, only: [:profit_and_loss_statement, :balance_sheet]
  before_action :non_operating_income, only: [:profit_and_loss_statement, :balance_sheet]
  before_action :non_operating_expenses, only: [:profit_and_loss_statement, :balance_sheet]
  before_action :extraordinary_gains, only: [:profit_and_loss_statement, :balance_sheet]
  before_action :extraordinary_loss, only: [:profit_and_loss_statement, :balance_sheet]
  before_action :corporate_inhabitant_and_enterprise_taxes, only: [:profit_and_loss_statement, :balance_sheet]
  
  before_action :cash_deposits, only: :balance_sheet
  before_action :trade_receivables, only: :balance_sheet
  before_action :inventories, only: :balance_sheet
  before_action :other_current_assets, only: :balance_sheet
  before_action :tangible_fixed_assets, only: :balance_sheet
  before_action :intangible_fixed_assets, only: :balance_sheet
  before_action :deferred_assets, only: :balance_sheet
  before_action :accounts_payable_trades, only: :balance_sheet
  before_action :other_current_liabilities, only: :balance_sheet
  before_action :fixed_liabilities, only: :balance_sheet
  before_action :capital_stocks, only: :balance_sheet
  before_action :retained_earnings, only: :balance_sheet
  
  def csv
  end

  def ocr_new
    @account = Account.new
    @compound_journals = @account.compound_journals.build
  end

  def ocr_create
    @account = Account.new(transfer_slip_account_params)
    if @account.save
      flash[:success] = "#{l(@account.accounting_date, format: :long)}の帳簿を新規作成しました。"
      redirect_to transfer_slip_new_accounts_url
    else
      flash[:danger] = "入力エラー。"
      render :ocr_new
    end
  end

  def ocr_upload
    unless params[:account][:image].nil?
      @res_text = Vision.get_image_data(params[:account][:image].path)
      @res_desc = @res_text[0]
      @tags = {}
      # @tags['date'] = @res_desc.slice('[12]\d{3}[/\-年](0?[1-9]|1[0-2])[/\-月](0?[1-9]|[12][0-9]|3[01])日?')
      # @tags['time'] = @res_desc.slice('((0?|1)[0-9]|2[0-3])[:時][0-5][0-9]分?')
      # @tags['tel'] = @res_desc.slice('0\d{1,3}-\d{1,4}-\d{4}')
      # @tags['total_price'] = @res_desc.slice('合計¥(0|[1-9]\d*|[1-9]\d{0,2}(,\d{3})+)$')
      @tax_rate_hash = @tax_rate_arys.to_h
      @tags["date"] = @res_desc.slice(/[0-9].*/)
      @tags['time'] = @res_desc.slice(/[0-9].*/)
      @tags['tel'] = @res_desc.slice(/0.*/)
      @tags['total_price'] = @res_desc.slice(/¥.*/)
      @tags = @tags.to_a
    end
    @account = Account.new
    @compound_journals = @account.compound_journals.build
    render :ocr_new
  end
  
  # --------------------------振替伝票作成-------------------------
  def transfer_slip_new
    @account = Account.new
    @compound_journals = @account.compound_journals.build
  end
  
  def transfer_slip_create
    @account = Account.new(transfer_slip_account_params)
    if @account.save
      flash[:success] = "#{l(@account.accounting_date, format: :long)}の帳簿を新規作成しました。"
      redirect_to transfer_slip_new_accounts_url
    else
      flash[:danger] = "入力エラー。"
      redirect_to transfer_slip_new_accounts_url
    end
  end
  
  def transfer_slip_edit
  end

  def transfer_slip_update
    if @account.update_attributes(transfer_slip_account_params)
      flash[:success] = "#{l(@account.accounting_date, format: :long)}のデータを変更しました。"
      redirect_to journal_books_accounts_url(accounting_date: @account.accounting_date)
    else
      flash[:danger] = "入力エラー。"
      redirect_to journal_books_accounts_url(accounting_date: @account.accounting_date)
    end
  end

  def transfer_slip_destroy
    @account.destroy
    flash[:success] = "#{l(@account.accounting_date, format: :long)}のデータを一件削除しました。"
    redirect_to journal_books_accounts_url(accounting_date: @account.accounting_date)
  end
  # -------------------------------------------------------------
  
  # --------------------------仕訳帳--------------------------------
  def journal_books
  end
  
  def csv_journal_books
    @ary_date = params[:first].to_date..params[:last].to_date
    @csv_accounts = Account.includes(:compound_journals).where(accounting_date: @ary_date).merge(Account.order("accounts.accounting_date ASC"))
    respond_to do |format|
      format.html
      format.csv do |csv|
        send_accounts_csv(@csv_accounts)
      end
    end
  end
  # ----------------------------------------------------------------

  # --------------------------総勘定元帳----------------------------
  def all_general_ledger
  end

  def master_general_ledger
    @carried_forward_balance = 0
    @this_month_last_balance = 0
    @param_account_title = params[:param_account_title]
    @general_ledger_accounts = Account.joins(:compound_journals).where(compound_journals: {account_title: @param_account_title}).or(Account.joins(:compound_journals).where(compound_journals: {right_account_title: @param_account_title})).distinct.merge(Account.order("accounts.accounting_date ASC"))
  end

  def sub_master_general_ledger
    @sub_carried_forward_balance = 0
    @sub_this_month_last_balance = 0
    @param_account_title = params[:param_account_title]
    @general_ledger_accounts = Account.joins(:compound_journals).where(compound_journals: {sub_account_title: @param_account_title}).or(Account.joins(:compound_journals).where(compound_journals: {right_sub_account_title: @param_account_title})).distinct.merge(Account.order("accounts.accounting_date ASC"))
  end
  # ----------------------------------------------------------------

  # --------------------------貸借対照表--------------------------------
  def balance_sheet
  end
  # ----------------------------------------------------------------

  # --------------------------損益計算書--------------------------------
  def profit_and_loss_statement
  end
  # ----------------------------------------------------------------

  private
    # ------------------------strong_parameter-----------------------
    def transfer_slip_account_params
      params.require(:account).permit(:accounting_date,
                                      :image,
                                      compound_journals_attributes:
                                      [
                                      :id,
                                      :account_title,
                                      :amount,
                                      :tax_rate,
                                      :description,
                                      :sub_account_title,
                                      :right_account_title,
                                      :right_amount,
                                      :right_tax_rate,
                                      :right_sub_account_title,
                                      :_destroy
                                      ]
                                    )
    end
    # --------------------------------------------------------------

    # ------------------------仕訳帳CSV出力-----------------------
    def send_accounts_csv(accounts)
      csv_data = CSV.generate do |csv|
        column_names = %w(日付 摘要 勘定科目 借方金額 勘定科目 貸方金額)
        csv << column_names
        accounts.each do |account|
          account.compound_journals.each do |compound_journal|
            column_values = [
              account.accounting_date,
              compound_journal.description,
              compound_journal.account_title,
              compound_journal.amount,
              compound_journal.right_account_title,
              compound_journal.right_amount
            ]
          
          csv << column_values
        end
        end
      end
      send_data(csv_data, filename: "#{l(Date.current, format: :long)}CSV出力、仕訳帳一覧.csv")
    end
end
